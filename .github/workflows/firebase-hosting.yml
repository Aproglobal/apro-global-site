name: Deploy to Firebase Hosting & Functions
run-name: "Build & Deploy â€¢ ${{ github.ref_name }} â€¢ by ${{ github.actor }}"

on:
  push:
    branches:
      - '**'         # all branches
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    # Only one live deployment at a time (preview can run concurrently per-branch)
    concurrency:
      group: deploy-live
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- Build-time env for Vite (client-exposed) ---
      - name: Create .env for build
        run: |
          cat << 'EOF' > .env
          VITE_SALES_EMAIL=${{ secrets.VITE_SALES_EMAIL }}
          VITE_GA_MEASUREMENT_ID=${{ secrets.VITE_GA_MEASUREMENT_ID }}
          VITE_AB_DEFAULT=A
          VITE_RECAPTCHA_SITE_KEY=${{ secrets.VITE_RECAPTCHA_SITE_KEY }}
          EOF
          echo ".env file created (values hidden):"
          cat .env | sed 's/=\(.*\)/=[HIDDEN]/'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # ðŸ”§ Self-heal: ensure @vitejs/plugin-react is installed (prevents build break)
      - name: Ensure @vitejs/plugin-react
        shell: bash
        run: |
          if ! npm ls @vitejs/plugin-react >/dev/null 2>&1; then
            echo "Installing @vitejs/plugin-react (not found in node_modules)"
            npm i -D @vitejs/plugin-react@^4
          else
            echo "@vitejs/plugin-react already present"
          fi

      - name: Build
        run: npm run build

      # âœ… Verify GA ID is injected (check the GA_ID variable assignment)
      - name: Verify GA ID replaced
        run: |
          test -f dist/index.html || (echo "âŒ dist/index.html not found" && exit 1)
          if grep -Eq "var GA_ID\s*=\s*['\"]G-[A-Z0-9]+['\"]" dist/index.html; then
            echo "âœ… GA ID is present in dist/index.html"
          else
            echo "âŒ GA ID not found (expected var GA_ID = 'G-XXXX')" && exit 1
          fi

      # ---- Functions(+ Firestore Indexes): run on all branches (as you requested) ----
      - name: Sync & Deploy Firestore Indexes + Functions
        shell: bash
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          SALES_TO: ${{ secrets.SALES_TO }}
          SENDGRID_FROM: ${{ secrets.SENDGRID_FROM }}
          SALES_BCC: ${{ secrets.SALES_BCC }}
          RECAPTCHA_SECRET: ${{ secrets.RECAPTCHA_SECRET }}
        run: |
          set -euo pipefail

          # 0) Skip if required secrets are missing
          missing=()
          [ -z "${SENDGRID_API_KEY:-}" ]  && missing+=("SENDGRID_API_KEY")
          [ -z "${SALES_TO:-}" ]         && missing+=("SALES_TO")
          [ -z "${SENDGRID_FROM:-}" ]    && missing+=("SENDGRID_FROM")
          [ -z "${RECAPTCHA_SECRET:-}" ] && missing+=("RECAPTCHA_SECRET")
          if [ ${#missing[@]} -gt 0 ]; then
            echo "ðŸŸ¡ Skipping functions deploy. Missing secrets: ${missing[*]}"
            exit 0
          fi

          # 1) ADC for Firebase CLI
          export GOOGLE_APPLICATION_CREDENTIALS="$RUNNER_TEMP/gcp.json"
          printf '%s' "$FIREBASE_SERVICE_ACCOUNT" > "$GOOGLE_APPLICATION_CREDENTIALS"

          # 2) Firebase CLI
          npm i -g firebase-tools@latest

          # 3) Sync secrets to Firebase Secret Manager
          sync_secret () {
            local NAME="$1"
            local VAL="$(printenv "$NAME" || true)"
            if [ -z "$VAL" ]; then
              VAL="__NONE__"
              echo "[$NAME] not provided â€” using placeholder '__NONE__'"
            fi
            printf "%s" "$VAL" | firebase functions:secrets:set "$NAME" \
              --project "$FIREBASE_PROJECT_ID" --force --non-interactive
            echo "Synced secret: $NAME"
          }
          sync_secret SENDGRID_API_KEY
          sync_secret SALES_TO
          sync_secret SENDGRID_FROM
          sync_secret SALES_BCC
          sync_secret RECAPTCHA_SECRET

          # 4) Build functions
          pushd functions
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
            npm run build
          popd

          # 5) Deploy indexes + functions
          firebase deploy \
            --only "firestore:indexes,functions" \
            --project "$FIREBASE_PROJECT_ID" \
            --non-interactive --force

      # ---- Hosting: PREVIEW for every branch (channel = branch name) ----
      - name: Deploy to Firebase Hosting (Preview Channel)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
          channelId: ${{ github.ref_name }}
          expires: 7d

      # ---- Hosting: LIVE also from selected branches (main/master/1107) ----
      - name: Deploy to Firebase Hosting (LIVE)
        if: ${{ github.ref_name == 'main' || github.ref_name == 'master' || github.ref_name == '1107' }}
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
          channelId: live
