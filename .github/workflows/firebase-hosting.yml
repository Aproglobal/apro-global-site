name: Deploy to Firebase Hosting

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # .env ÌååÏùº ÏÉùÏÑ± (ViteÏö©)
      - name: Create .env for build
        run: |
          cat << 'EOF' > .env
          VITE_SALES_EMAIL=${{ secrets.VITE_SALES_EMAIL }}
          VITE_GA_MEASUREMENT_ID=${{ secrets.VITE_GA_MEASUREMENT_ID }}
          VITE_AB_DEFAULT=A
          EOF
          echo ".env file created (values hidden):"
          cat .env | sed 's/=\(.*\)/=[HIDDEN]/'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            echo "package-lock.json detected -> using npm ci"
            npm ci
          else
            echo "No package-lock.json -> using npm install"
            npm install
          fi

      - name: Build
        run: npm run build

      # dist/index.html ÏïàÏóê GA IDÍ∞Ä ÏπòÌôòÎêòÏóàÎäîÏßÄ ÌôïÏù∏
      - name: Verify GA ID replaced
        run: |
          if [ ! -f dist/index.html ]; then
            echo "‚ùå dist/index.html not found. Is Vite output directory 'dist'?" && exit 1
          fi
          echo "Checking GA ID in dist/index.html..."
          if grep -q "googletagmanager.com/gtag/js?id=G-" dist/index.html; then
            echo "‚úÖ GA ID found in dist/index.html"
          else
            echo "‚ùå GA ID NOT found in dist/index.html (replacement failed)."
            echo "Snippet around GA:"
            sed -n '/googletagmanager\.com\/gtag\/js/p' dist/index.html | head -n 5
            exit 1
          fi

      # === üîê GitHub Secrets ‚Üí Firebase Secret Manager ÎèôÍ∏∞Ìôî ===
      # Firebase CLIÍ∞Ä ÏÑúÎπÑÏä§ Í≥ÑÏ†ïÏúºÎ°ú Ïù∏Ï¶ùÎêòÎèÑÎ°ù ADC ÌååÏùºÏùÑ ÎßåÎì§Í≥†,
      # functions:secrets:set Î°ú ÏµúÏã† Î≤ÑÏ†ÑÏùÑ Îì±Î°ù(ÌöåÏ†Ñ)Ìï©ÎãàÎã§.
      - name: Sync Firebase Secrets from GitHub
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          SALES_TO: ${{ secrets.SALES_TO }}
          FROM: ${{ secrets.FROM }}
          SALES_BCC: ${{ secrets.SALES_BCC }} # optional
        run: |
          set -euo pipefail

          # 1) ÏÑúÎπÑÏä§ Í≥ÑÏ†ï JSONÏùÑ ÌååÏùºÎ°ú Ï†ÄÏû• ‚Üí ADC Ïù∏Ï¶ù Í≤ΩÎ°ú ÏßÄÏ†ï
          export GOOGLE_APPLICATION_CREDENTIALS="$RUNNER_TEMP/gcp.json"
          printf '%s' "$FIREBASE_SERVICE_ACCOUNT" > "$GOOGLE_APPLICATION_CREDENTIALS"

          # 2) Firebase CLI ÏÑ§Ïπò
          npm i -g firebase-tools@latest

          # 3) Helper: Í∞íÏù¥ ÏûàÏúºÎ©¥ Secret ManagerÏóê ÏÉà Î≤ÑÏ†ÑÏúºÎ°ú ÏÑ∏ÌåÖ
          sync_secret () {
            local NAME="$1"
            local VAL="${!NAME:-}"
            if [ -n "$VAL" ]; then
              printf "%s" "$VAL" | firebase functions:secrets:set "$NAME" \
                --project "$FIREBASE_PROJECT_ID" \
                --force
              echo "Synced secret: $NAME"
            else
              echo "Skip empty: $NAME"
            fi
          }

          sync_secret SENDGRID_API_KEY
          sync_secret SALES_TO
          sync_secret FROM
          sync_secret SALES_BCC

      # (ÏÑ†ÌÉù) ÌÅ¥ÎùºÏö∞Îìú Ìï®Ïàò Î∞∞Ìè¨: ÏãúÌÅ¨Î¶øÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ Ìï®ÏàòÎäî Ïû¨Î∞∞Ìè¨ Ïãú ÏµúÏã† Î≤ÑÏ†ÑÏùÑ Î∞îÏù∏Îî©Ìï©ÎãàÎã§.
      # functions ÎîîÎ†âÌÜ†Î¶¨Í∞Ä ÏóÜÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú Í±¥ÎÑàÎúÄ
      - name: Deploy Cloud Functions (if present)
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          set -euo pipefail
          export GOOGLE_APPLICATION_CREDENTIALS="$RUNNER_TEMP/gcp.json"
          printf '%s' "$FIREBASE_SERVICE_ACCOUNT" > "$GOOGLE_APPLICATION_CREDENTIALS"
          if [ -d "functions" ]; then
            echo "functions/ directory detected ‚Üí deploying functions"
            npm i -g firebase-tools@latest
            firebase deploy --only functions --project "$FIREBASE_PROJECT_ID"
          else
            echo "No functions/ directory ‚Üí skip functions deploy"
          fi

      # Firebase Hosting Î∞∞Ìè¨ (Í∏∞Ï°¥ Ïï°ÏÖò Ïú†ÏßÄ)
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
