name: Deploy to Firebase Hosting

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # .env 파일을 빌드 시점에 생성 (시크릿에서 값 가져옴)
      - name: Create .env for build
        run: |
          cat << 'EOF' > .env
          VITE_SALES_EMAIL=${{ secrets.VITE_SALES_EMAIL }}
          VITE_GA_MEASUREMENT_ID=${{ secrets.VITE_GA_MEASUREMENT_ID }}
          VITE_GTM_ID=${{ secrets.VITE_GTM_ID }}
          VITE_AB_DEFAULT=A
          EOF
          echo ".env file created (values hidden):"
          cat .env | sed 's/=\(.*\)/=[HIDDEN]/'

      # lockfile이 있으면 npm ci, 없으면 npm install
      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            echo "package-lock.json detected -> using npm ci"
            npm ci
          else
            echo "No package-lock.json -> using npm install"
            npm install
          fi

      - name: Build
        run: npm run build

      # dist/index.html 안에 GTM ID가 치환되었는지 확인
      - name: Verify GTM ID replaced
        run: |
          if [ ! -f dist/index.html ]; then
            echo "❌ dist/index.html not found. Is Vite output directory 'dist'?" && exit 1
          fi
          echo "Checking GTM ID in dist/index.html..."
          if grep -q "googletagmanager.com/gtm.js?id=GTM-" dist/index.html; then
            echo "✅ GTM ID found in dist/index.html"
          else
            echo "❌ GTM ID NOT found in dist/index.html (replacement failed)."
            echo "Snippet around GTM:"
            sed -n '/googletagmanager\.com\/gtm\.js/p' dist/index.html | head -n 5
            exit 1
          fi

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
